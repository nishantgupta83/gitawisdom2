name: Production Readiness Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_full_suite:
        description: 'Run full production test suite'
        required: false
        default: 'true'

jobs:
  production-readiness:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: |
        flutter pub get
        flutter packages pub run build_runner build --delete-conflicting-outputs

    - name: ðŸ” Static Analysis
      run: |
        flutter analyze --no-fatal-infos
        echo "âœ… Static analysis completed"

    - name: ðŸ§ª Unit Tests
      run: |
        flutter test test/ --coverage --reporter=json > test_results.json
        echo "âœ… Unit tests completed"

    - name: ðŸ—ï¸ Build Validation
      run: |
        echo "ðŸ”§ Testing debug build..."
        flutter build apk --debug
        
        echo "ðŸš€ Testing release build..."
        flutter build apk --release
        
        echo "ðŸ“¦ Testing app bundle..."
        flutter build appbundle --release
        
        echo "âœ… All builds successful"

    - name: ðŸŒ Production Configuration Check
      run: |
        echo "ðŸ” Checking Android manifest permissions..."
        if ! grep -q "android.permission.INTERNET" android/app/src/main/AndroidManifest.xml; then
          echo "âŒ CRITICAL: Missing INTERNET permission in AndroidManifest.xml"
          exit 1
        fi
        echo "âœ… Internet permission found"
        
        echo "ðŸ” Checking Supabase configuration..."
        if ! grep -q "Environment.supabaseUrl" lib/main.dart; then
          echo "âŒ CRITICAL: Supabase not configured with Environment"
          exit 1
        fi
        echo "âœ… Supabase environment configuration found"
        
        echo "ðŸ” Checking for duplicate Supabase initialization..."
        INIT_COUNT=$(grep -c "Supabase.initialize" lib/main.dart || true)
        if [ $INIT_COUNT -gt 1 ]; then
          echo "âŒ CRITICAL: Multiple Supabase.initialize calls found"
          grep -n "Supabase.initialize" lib/main.dart
          exit 1
        fi
        echo "âœ… Single Supabase initialization confirmed"

    - name: ðŸ“Š Release Artifact Validation
      run: |
        echo "ðŸ“± Validating APK..."
        APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
        if [ ! -f "$APK_PATH" ]; then
          echo "âŒ APK not found at $APK_PATH"
          exit 1
        fi
        
        APK_SIZE=$(stat -c%s "$APK_PATH")
        echo "APK size: $APK_SIZE bytes"
        
        if [ $APK_SIZE -lt 50000000 ] || [ $APK_SIZE -gt 100000000 ]; then
          echo "âš ï¸ Warning: APK size $APK_SIZE seems unusual (expected 50-100MB)"
        fi
        
        echo "ðŸ“¦ Validating AAB..."
        AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
        if [ ! -f "$AAB_PATH" ]; then
          echo "âŒ AAB not found at $AAB_PATH"
          exit 1
        fi
        
        AAB_SIZE=$(stat -c%s "$AAB_PATH")
        echo "AAB size: $AAB_SIZE bytes"
        
        if [ $AAB_SIZE -lt 40000000 ] || [ $AAB_SIZE -gt 80000000 ]; then
          echo "âš ï¸ Warning: AAB size $AAB_SIZE seems unusual (expected 40-80MB)"
        fi
        
        echo "âœ… Release artifacts validated"

    - name: ðŸš¨ Critical Issue Detection
      run: |
        echo "ðŸ” Scanning for critical issues..."
        
        # Check for hardcoded credentials
        if grep -r "password\|secret\|key.*=" lib/ --include="*.dart" | grep -v "keyAlias\|keyPassword" | grep -v "// "; then
          echo "âŒ CRITICAL: Potential hardcoded credentials found"
          exit 1
        fi
        
        # Check for debug prints in production code
        DEBUG_PRINTS=$(grep -r "print(" lib/ --include="*.dart" | grep -v "debugPrint" | wc -l || true)
        if [ $DEBUG_PRINTS -gt 5 ]; then
          echo "âš ï¸ Warning: $DEBUG_PRINTS print() statements found (consider using debugPrint)"
        fi
        
        # Check for TODOs marked as critical
        if grep -r "TODO.*CRITICAL\|FIXME.*CRITICAL" lib/ --include="*.dart"; then
          echo "âŒ CRITICAL TODOs found that must be resolved before release"
          exit 1
        fi
        
        echo "âœ… No critical issues detected"

    - name: ðŸ“‹ Generate Test Report
      if: always()
      run: |
        echo "# Production Readiness Test Report" > test_report.md
        echo "" >> test_report.md
        echo "## Build Information" >> test_report.md
        echo "- **Commit**: ${{ github.sha }}" >> test_report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> test_report.md
        echo "- **Flutter Version**: $(flutter --version | head -1)" >> test_report.md
        echo "" >> test_report.md
        
        echo "## Test Results" >> test_report.md
        if [ -f test_results.json ]; then
          echo "- **Unit Tests**: Completed" >> test_report.md
        fi
        
        if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
          APK_SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-release.apk)
          echo "- **APK Size**: ${APK_SIZE} bytes" >> test_report.md
        fi
        
        if [ -f build/app/outputs/bundle/release/app-release.aab ]; then
          AAB_SIZE=$(stat -c%s build/app/outputs/bundle/release/app-release.aab)
          echo "- **AAB Size**: ${AAB_SIZE} bytes" >> test_report.md
        fi
        
        echo "" >> test_report.md
        echo "## Status" >> test_report.md
        echo "âœ… Production readiness tests completed" >> test_report.md
        
        cat test_report.md

    - name: ðŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: production-test-results
        path: |
          test_results.json
          test_report.md
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab

    - name: ðŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('test_report.md')) {
            const report = fs.readFileSync('test_report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }