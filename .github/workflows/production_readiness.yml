name: Production Readiness Tests

# ============================================================================
# GitaWisdom Production CI/CD Pipeline
# ============================================================================
# Customized from flutter_ci_template.yml for GitaWisdom mobile app
# Tests iOS and Android builds with Supabase integration
# ============================================================================

on:
  push:
    branches: [main, oct17apple, develop]
  pull_request:
    branches: [main, oct17apple]
  workflow_dispatch:
    inputs:
      run_full_suite:
        description: 'Run full production test suite'
        required: false
        default: 'true'
      skip_ios:
        description: 'Skip iOS build (faster testing)'
        required: false
        default: 'false'

# Configuration specific to GitaWisdom
env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'
  MIN_COVERAGE_PERCENT: 60
  ENABLE_INTEGRATION_TESTS: 'true'

  # Build size limits (GitaWisdom is ~106MB APK, ~78MB AAB)
  MAX_ANDROID_APK_SIZE: 120000000    # 120MB (allow headroom for growth)
  MAX_ANDROID_AAB_SIZE: 90000000     # 90MB
  MAX_IOS_APP_SIZE: 150000000        # 150MB

jobs:
  # --------------------------------------------------------------------------
  # Setup and Dependency Management
  # --------------------------------------------------------------------------
  setup:
    name: üì¶ Setup & Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-gitawisdom-${{ hashFiles('**/pubspec.lock') }}

      - name: üì¶ Install Dependencies
        run: flutter pub get

      - name: üèóÔ∏è Run Build Runner
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: ‚úÖ Dependencies Installed
        run: echo "Setup completed successfully"

  # --------------------------------------------------------------------------
  # Static Analysis
  # --------------------------------------------------------------------------
  static-analysis:
    name: üîç Static Analysis
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: üì¶ Get Dependencies
        run: flutter pub get

      - name: üîç Flutter Analyze
        run: |
          echo "Running static analysis..."
          flutter analyze --no-fatal-infos
          echo "‚úÖ Static analysis passed"

  # --------------------------------------------------------------------------
  # Unit Tests with Coverage
  # --------------------------------------------------------------------------
  unit-tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: üì¶ Get Dependencies
        run: flutter pub get

      - name: üß™ Run Tests with Coverage
        run: |
          # Check if test directory exists
          if [ -d "test" ]; then
            echo "Running unit tests..."
            flutter test --coverage --reporter=expanded
          else
            echo "‚è≠Ô∏è  No test directory found - creating basic test structure recommended"
            exit 0
          fi

      - name: üìä Coverage Report
        if: hashFiles('coverage/lcov.info') != ''
        run: |
          if [ -f "coverage/lcov.info" ]; then
            sudo apt-get update -qq
            sudo apt-get install -y lcov

            # Generate coverage report
            genhtml coverage/lcov.info -o coverage/html

            # Calculate coverage percentage
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
            echo "üìä Test Coverage: $COVERAGE%"

            if (( $(echo "$COVERAGE < ${{ env.MIN_COVERAGE_PERCENT }}" | bc -l) )); then
              echo "‚ö†Ô∏è  Coverage $COVERAGE% is below target ${{ env.MIN_COVERAGE_PERCENT }}%"
              # Don't fail - just warn for now
            else
              echo "‚úÖ Coverage meets minimum requirement"
            fi
          fi

      - name: üì§ Upload Coverage
        if: hashFiles('coverage/lcov.info') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # --------------------------------------------------------------------------
  # Integration Tests
  # --------------------------------------------------------------------------
  integration-tests:
    name: üéØ Integration Tests
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: üì¶ Get Dependencies
        run: flutter pub get

      - name: üéØ Run Integration Tests
        run: |
          if [ -d "integration_test" ]; then
            echo "Running integration tests..."
            flutter test integration_test --reporter=expanded
            echo "‚úÖ Integration tests passed"
          else
            echo "‚è≠Ô∏è  No integration tests found"
          fi

  # --------------------------------------------------------------------------
  # Security Scanning
  # --------------------------------------------------------------------------
  security-scan:
    name: üîí Security Checks
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Scan for Hardcoded Secrets
        run: |
          echo "üîç Scanning for hardcoded credentials..."

          # Check for passwords
          if grep -rn "password\s*=\s*['\"]" lib/ --include="*.dart" | grep -v "keyPassword" | grep -v "// "; then
            echo "‚ùå Found potential hardcoded passwords"
            exit 1
          fi

          # Check for API keys (excluding dart-define references)
          if grep -rn "api.*key\s*=\s*['\"][^$]" lib/ --include="*.dart" | grep -v "String.fromEnvironment" | grep -v "// "; then
            echo "‚ö†Ô∏è  Warning: Potential hardcoded API keys found"
          fi

          echo "‚úÖ No critical security issues"

      - name: üîç Check .env Files Not Committed
        run: |
          if git ls-files | grep -E "^\.env$|^\.env\.production$|^\.env\.local$"; then
            echo "‚ùå CRITICAL: .env files committed to repository"
            exit 1
          fi
          echo "‚úÖ No .env files in git"

      - name: üîç Validate Keystore Security
        run: |
          # Ensure keystores aren't committed
          if git ls-files android/ | grep -E "\.jks$|\.keystore$"; then
            echo "‚ùå CRITICAL: Keystore files found in repository"
            exit 1
          fi

          # Check keystore.properties isn't committed with passwords
          if git ls-files | grep "keystore\.properties"; then
            if grep -q "storePassword\|keyPassword" android/keystore.properties; then
              echo "‚ùå CRITICAL: Keystore passwords in repository"
              exit 1
            fi
          fi

          echo "‚úÖ Keystore security validated"

      - name: üîç Supabase Configuration Check
        run: |
          echo "üîç Validating Supabase configuration..."

          # Ensure using Environment variables, not hardcoded
          if grep -rn "https://.*\.supabase\.co" lib/ --include="*.dart" | grep -v "String.fromEnvironment"; then
            echo "‚ùå Found hardcoded Supabase URLs (should use dart-define)"
            exit 1
          fi

          # Check main.dart uses Environment class
          if ! grep -q "Environment.supabaseUrl" lib/main.dart; then
            echo "‚ùå main.dart should use Environment.supabaseUrl"
            exit 1
          fi

          echo "‚úÖ Supabase configuration secure"

  # --------------------------------------------------------------------------
  # Android Build Validation
  # --------------------------------------------------------------------------
  android-build:
    name: ü§ñ Android Build
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, security-scan]

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: üì¶ Get Dependencies
        run: |
          flutter pub get
          flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: üîß Build Debug APK
        run: |
          echo "üîß Building debug APK..."
          flutter build apk --debug \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=development
          echo "‚úÖ Debug APK built"

      - name: üöÄ Build Release APK
        if: github.event.inputs.run_full_suite != 'false'
        run: |
          echo "üöÄ Building release APK..."
          flutter build apk --release \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=production
          echo "‚úÖ Release APK built"

      - name: üì¶ Build App Bundle
        if: github.event.inputs.run_full_suite != 'false'
        run: |
          echo "üì¶ Building app bundle..."
          flutter build appbundle --release \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=production
          echo "‚úÖ App bundle built"

      - name: üìä Validate Build Artifacts
        run: |
          echo "üìä Validating Android builds..."

          # Validate APK
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(stat -c%s "$APK_PATH")
            APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
            echo "‚úÖ APK: ${APK_SIZE_MB}MB ($APK_SIZE bytes)"

            if [ $APK_SIZE -gt ${{ env.MAX_ANDROID_APK_SIZE }} ]; then
              echo "‚ùå APK size ${APK_SIZE_MB}MB exceeds maximum"
              exit 1
            fi
          fi

          # Validate AAB
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            AAB_SIZE=$(stat -c%s "$AAB_PATH")
            AAB_SIZE_MB=$((AAB_SIZE / 1024 / 1024))
            echo "‚úÖ AAB: ${AAB_SIZE_MB}MB ($AAB_SIZE bytes)"

            if [ $AAB_SIZE -gt ${{ env.MAX_ANDROID_AAB_SIZE }} ]; then
              echo "‚ùå AAB size ${AAB_SIZE_MB}MB exceeds maximum"
              exit 1
            fi
          fi

          echo "‚úÖ All builds within size limits"

      - name: üîç Android Manifest Validation
        run: |
          echo "üîç Checking AndroidManifest.xml..."

          MANIFEST="android/app/src/main/AndroidManifest.xml"

          # Check required permissions
          if ! grep -q "android.permission.INTERNET" "$MANIFEST"; then
            echo "‚ùå Missing INTERNET permission"
            exit 1
          fi

          # Validate package name
          if ! grep -q "com.hub4apps.gitawisdom" "$MANIFEST"; then
            echo "‚ö†Ô∏è  Package name validation failed"
          fi

          echo "‚úÖ AndroidManifest.xml validated"

      - name: üì§ Upload Android Artifacts
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: android-production-builds
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          retention-days: 14

  # --------------------------------------------------------------------------
  # iOS Build Validation
  # --------------------------------------------------------------------------
  ios-build:
    name: üçé iOS Build
    runs-on: macos-latest
    needs: [static-analysis, unit-tests, security-scan]
    if: github.event.inputs.skip_ios != 'true'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: üì¶ Get Dependencies
        run: |
          flutter pub get
          flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: üçé Install CocoaPods Dependencies
        run: |
          cd ios
          pod install --repo-update
          cd ..

      - name: üèóÔ∏è Build iOS App (No Code Signing)
        run: |
          echo "üîß Building iOS app..."
          flutter build ios --release --no-codesign \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=production
          echo "‚úÖ iOS build completed"

      - name: üìä Validate iOS Build
        run: |
          echo "üìä Validating iOS build..."

          APP_PATH="build/ios/iphoneos/Runner.app"

          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sk "$APP_PATH" | cut -f1)
            APP_SIZE_KB=$APP_SIZE
            APP_SIZE_MB=$((APP_SIZE / 1024))
            echo "‚úÖ iOS App: ${APP_SIZE_MB}MB"

            if [ $((APP_SIZE_KB * 1024)) -gt ${{ env.MAX_IOS_APP_SIZE }} ]; then
              echo "‚ùå iOS app size exceeds maximum"
              exit 1
            fi
          else
            echo "‚ùå iOS build not found"
            exit 1
          fi

      - name: üîç Info.plist Validation
        run: |
          echo "üîç Validating Info.plist..."

          INFO_PLIST="ios/Runner/Info.plist"

          # Check bundle identifier
          if ! grep -q "com.hub4apps.gitawisdom" "$INFO_PLIST"; then
            echo "‚ö†Ô∏è  Bundle identifier validation warning"
          fi

          # Check Google Sign-In configuration
          if ! grep -q "GIDClientID" "$INFO_PLIST"; then
            echo "‚ö†Ô∏è  Google Sign-In configuration missing"
          fi

          # Check URL schemes for deep linking
          if ! grep -q "CFBundleURLSchemes" "$INFO_PLIST"; then
            echo "‚ö†Ô∏è  URL schemes not configured"
          fi

          echo "‚úÖ Info.plist validated"

      - name: üì§ Upload iOS Build
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 14

  # --------------------------------------------------------------------------
  # Performance Analysis
  # --------------------------------------------------------------------------
  performance-analysis:
    name: ‚ö° Performance Analysis
    runs-on: ubuntu-latest
    needs: [android-build]
    if: always()

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üìä APK Composition Analysis
        run: |
          echo "üìä Analyzing APK composition..."

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"

          if [ -f "$APK_PATH" ]; then
            # Extract APK
            mkdir -p apk_analysis
            unzip -q "$APK_PATH" -d apk_analysis

            echo "=== Native Libraries ==="
            du -sh apk_analysis/lib/* 2>/dev/null | sort -h || echo "No native libs"

            echo "=== Assets ==="
            du -sh apk_analysis/assets/* 2>/dev/null | sort -h || echo "No assets"

            echo "=== Top 10 Largest Files ==="
            find apk_analysis -type f -exec du -h {} + | sort -rh | head -10
          else
            echo "‚è≠Ô∏è  APK not available for analysis"
          fi

  # --------------------------------------------------------------------------
  # Production Readiness Report
  # --------------------------------------------------------------------------
  production-report:
    name: üìã Production Report
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, security-scan, android-build, ios-build]
    if: always()

    steps:
      - name: üìã Generate Production Readiness Report
        run: |
          echo "# üéØ GitaWisdom Production Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter Version**: ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Static Analysis | ${{ needs.static-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.android-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Build | ${{ needs.ios-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [[ "${{ needs.static-analysis.result }}" == "success" ]] && \
             [[ "${{ needs.unit-tests.result }}" == "success" ]] && \
             [[ "${{ needs.security-scan.result }}" == "success" ]] && \
             [[ "${{ needs.android-build.result }}" == "success" ]]; then
            echo "## ‚úÖ Production Ready" >> $GITHUB_STEP_SUMMARY
            echo "All critical checks passed. Build is ready for store submission." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ö†Ô∏è  Action Required" >> $GITHUB_STEP_SUMMARY
            echo "Some checks failed. Review the job results above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const staticAnalysis = '${{ needs.static-analysis.result }}';
            const unitTests = '${{ needs.unit-tests.result }}';
            const securityScan = '${{ needs.security-scan.result }}';
            const androidBuild = '${{ needs.android-build.result }}';
            const iosBuild = '${{ needs.ios-build.result }}';

            const allSuccess = androidBuild === 'success' && iosBuild === 'success';
            const status = allSuccess ? '‚úÖ All checks passed! Ready for production.' : '‚ö†Ô∏è Some checks failed. Please review.';

            const output = `## üéØ Production Readiness Check

            | Component | Status |
            |-----------|--------|
            | Static Analysis | ${staticAnalysis} |
            | Unit Tests | ${unitTests} |
            | Security Scan | ${securityScan} |
            | Android Build | ${androidBuild} |
            | iOS Build | ${iosBuild} |

            ${status}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
