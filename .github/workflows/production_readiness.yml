name: Production Readiness Tests

# ============================================================================
# GitaWisdom Production CI/CD Pipeline
# ============================================================================
# Customized from flutter_ci_template.yml for GitaWisdom mobile app
# Tests iOS and Android builds with Supabase integration
# ============================================================================

on:
  push:
    branches: [main, oct17apple, develop]
  pull_request:
    branches: [main, oct17apple]
  workflow_dispatch:
    inputs:
      run_full_suite:
        description: 'Run full production test suite'
        required: false
        default: 'true'
      skip_ios:
        description: 'Skip iOS build (faster testing)'
        required: false
        default: 'false'

# Configuration specific to GitaWisdom
env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'
  MIN_COVERAGE_PERCENT: 60
  ENABLE_INTEGRATION_TESTS: 'true'

  # Build size limits (GitaWisdom is ~106MB APK, ~78MB AAB)
  MAX_ANDROID_APK_SIZE: 120000000    # 120MB (allow headroom for growth)
  MAX_ANDROID_AAB_SIZE: 90000000     # 90MB
  MAX_IOS_APP_SIZE: 150000000        # 150MB

jobs:
  # --------------------------------------------------------------------------
  # Setup and Dependency Management
  # --------------------------------------------------------------------------
  setup:
    name: ğŸ“¦ Setup & Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-gitawisdom-${{ hashFiles('**/pubspec.lock') }}

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Run Build Runner
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: âœ… Dependencies Installed
        run: echo "Setup completed successfully"

  # --------------------------------------------------------------------------
  # Static Analysis
  # --------------------------------------------------------------------------
  static-analysis:
    name: ğŸ” Static Analysis
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ” Flutter Analyze
        run: |
          echo "Running static analysis..."
          flutter analyze --no-fatal-infos
          echo "âœ… Static analysis passed"

  # --------------------------------------------------------------------------
  # Unit Tests with Coverage
  # --------------------------------------------------------------------------
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ§ª Run Tests with Coverage
        run: |
          # Check if test directory exists
          if [ -d "test" ]; then
            echo "Running unit tests..."
            flutter test --coverage --reporter=expanded
          else
            echo "â­ï¸  No test directory found - creating basic test structure recommended"
            exit 0
          fi

      - name: ğŸ“Š Coverage Report
        if: hashFiles('coverage/lcov.info') != ''
        run: |
          if [ -f "coverage/lcov.info" ]; then
            sudo apt-get update -qq
            sudo apt-get install -y lcov

            # Generate coverage report
            genhtml coverage/lcov.info -o coverage/html

            # Calculate coverage percentage
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
            echo "ğŸ“Š Test Coverage: $COVERAGE%"

            if (( $(echo "$COVERAGE < ${{ env.MIN_COVERAGE_PERCENT }}" | bc -l) )); then
              echo "âš ï¸  Coverage $COVERAGE% is below target ${{ env.MIN_COVERAGE_PERCENT }}%"
              # Don't fail - just warn for now
            else
              echo "âœ… Coverage meets minimum requirement"
            fi
          fi

      - name: ğŸ“¤ Upload Coverage
        if: hashFiles('coverage/lcov.info') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # --------------------------------------------------------------------------
  # Integration Tests
  # --------------------------------------------------------------------------
  integration-tests:
    name: ğŸ¯ Integration Tests
    runs-on: ubuntu-latest
    needs: setup
    if: env.ENABLE_INTEGRATION_TESTS == 'true'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ¯ Run Integration Tests
        run: |
          if [ -d "integration_test" ]; then
            echo "Running integration tests..."
            flutter test integration_test --reporter=expanded
            echo "âœ… Integration tests passed"
          else
            echo "â­ï¸  No integration tests found"
          fi

  # --------------------------------------------------------------------------
  # Security Scanning
  # --------------------------------------------------------------------------
  security-scan:
    name: ğŸ”’ Security Checks
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Scan for Hardcoded Secrets
        run: |
          echo "ğŸ” Scanning for hardcoded credentials..."

          # Check for passwords
          if grep -rn "password\s*=\s*['\"]" lib/ --include="*.dart" | grep -v "keyPassword" | grep -v "// "; then
            echo "âŒ Found potential hardcoded passwords"
            exit 1
          fi

          # Check for API keys (excluding dart-define references)
          if grep -rn "api.*key\s*=\s*['\"][^$]" lib/ --include="*.dart" | grep -v "String.fromEnvironment" | grep -v "// "; then
            echo "âš ï¸  Warning: Potential hardcoded API keys found"
          fi

          echo "âœ… No critical security issues"

      - name: ğŸ” Check .env Files Not Committed
        run: |
          if git ls-files | grep -E "^\.env$|^\.env\.production$|^\.env\.local$"; then
            echo "âŒ CRITICAL: .env files committed to repository"
            exit 1
          fi
          echo "âœ… No .env files in git"

      - name: ğŸ” Validate Keystore Security
        run: |
          # Ensure keystores aren't committed
          if git ls-files android/ | grep -E "\.jks$|\.keystore$"; then
            echo "âŒ CRITICAL: Keystore files found in repository"
            exit 1
          fi

          # Check keystore.properties isn't committed with passwords
          if git ls-files | grep "keystore\.properties"; then
            if grep -q "storePassword\|keyPassword" android/keystore.properties; then
              echo "âŒ CRITICAL: Keystore passwords in repository"
              exit 1
            fi
          fi

          echo "âœ… Keystore security validated"

      - name: ğŸ” Supabase Configuration Check
        run: |
          echo "ğŸ” Validating Supabase configuration..."

          # Ensure using Environment variables, not hardcoded
          if grep -rn "https://.*\.supabase\.co" lib/ --include="*.dart" | grep -v "String.fromEnvironment"; then
            echo "âŒ Found hardcoded Supabase URLs (should use dart-define)"
            exit 1
          fi

          # Check main.dart uses Environment class
          if ! grep -q "Environment.supabaseUrl" lib/main.dart; then
            echo "âŒ main.dart should use Environment.supabaseUrl"
            exit 1
          fi

          echo "âœ… Supabase configuration secure"

  # --------------------------------------------------------------------------
  # Android Build Validation
  # --------------------------------------------------------------------------
  android-build:
    name: ğŸ¤– Android Build
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, security-scan]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: |
          flutter pub get
          flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ”§ Build Debug APK
        run: |
          echo "ğŸ”§ Building debug APK..."
          flutter build apk --debug \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=development
          echo "âœ… Debug APK built"

      - name: ğŸš€ Build Release APK
        if: github.event.inputs.run_full_suite != 'false'
        run: |
          echo "ğŸš€ Building release APK..."
          flutter build apk --release \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=production
          echo "âœ… Release APK built"

      - name: ğŸ“¦ Build App Bundle
        if: github.event.inputs.run_full_suite != 'false'
        run: |
          echo "ğŸ“¦ Building app bundle..."
          flutter build appbundle --release \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=production
          echo "âœ… App bundle built"

      - name: ğŸ“Š Validate Build Artifacts
        run: |
          echo "ğŸ“Š Validating Android builds..."

          # Validate APK
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(stat -c%s "$APK_PATH")
            APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
            echo "âœ… APK: ${APK_SIZE_MB}MB ($APK_SIZE bytes)"

            if [ $APK_SIZE -gt ${{ env.MAX_ANDROID_APK_SIZE }} ]; then
              echo "âŒ APK size ${APK_SIZE_MB}MB exceeds maximum"
              exit 1
            fi
          fi

          # Validate AAB
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            AAB_SIZE=$(stat -c%s "$AAB_PATH")
            AAB_SIZE_MB=$((AAB_SIZE / 1024 / 1024))
            echo "âœ… AAB: ${AAB_SIZE_MB}MB ($AAB_SIZE bytes)"

            if [ $AAB_SIZE -gt ${{ env.MAX_ANDROID_AAB_SIZE }} ]; then
              echo "âŒ AAB size ${AAB_SIZE_MB}MB exceeds maximum"
              exit 1
            fi
          fi

          echo "âœ… All builds within size limits"

      - name: ğŸ” Android Manifest Validation
        run: |
          echo "ğŸ” Checking AndroidManifest.xml..."

          MANIFEST="android/app/src/main/AndroidManifest.xml"

          # Check required permissions
          if ! grep -q "android.permission.INTERNET" "$MANIFEST"; then
            echo "âŒ Missing INTERNET permission"
            exit 1
          fi

          # Validate package name
          if ! grep -q "com.hub4apps.gitawisdom" "$MANIFEST"; then
            echo "âš ï¸  Package name validation failed"
          fi

          echo "âœ… AndroidManifest.xml validated"

      - name: ğŸ“¤ Upload Android Artifacts
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: android-production-builds
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          retention-days: 14

  # --------------------------------------------------------------------------
  # iOS Build Validation
  # --------------------------------------------------------------------------
  ios-build:
    name: ğŸ iOS Build
    runs-on: macos-latest
    needs: [static-analysis, unit-tests, security-scan]
    if: github.event.inputs.skip_ios != 'true'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: |
          flutter pub get
          flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ Install CocoaPods Dependencies
        run: |
          cd ios
          pod install --repo-update
          cd ..

      - name: ğŸ—ï¸ Build iOS App (No Code Signing)
        run: |
          echo "ğŸ”§ Building iOS app..."
          flutter build ios --release --no-codesign \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=APP_ENV=production
          echo "âœ… iOS build completed"

      - name: ğŸ“Š Validate iOS Build
        run: |
          echo "ğŸ“Š Validating iOS build..."

          APP_PATH="build/ios/iphoneos/Runner.app"

          if [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sk "$APP_PATH" | cut -f1)
            APP_SIZE_KB=$APP_SIZE
            APP_SIZE_MB=$((APP_SIZE / 1024))
            echo "âœ… iOS App: ${APP_SIZE_MB}MB"

            if [ $((APP_SIZE_KB * 1024)) -gt ${{ env.MAX_IOS_APP_SIZE }} ]; then
              echo "âŒ iOS app size exceeds maximum"
              exit 1
            fi
          else
            echo "âŒ iOS build not found"
            exit 1
          fi

      - name: ğŸ” Info.plist Validation
        run: |
          echo "ğŸ” Validating Info.plist..."

          INFO_PLIST="ios/Runner/Info.plist"

          # Check bundle identifier
          if ! grep -q "com.hub4apps.gitawisdom" "$INFO_PLIST"; then
            echo "âš ï¸  Bundle identifier validation warning"
          fi

          # Check Google Sign-In configuration
          if ! grep -q "GIDClientID" "$INFO_PLIST"; then
            echo "âš ï¸  Google Sign-In configuration missing"
          fi

          # Check URL schemes for deep linking
          if ! grep -q "CFBundleURLSchemes" "$INFO_PLIST"; then
            echo "âš ï¸  URL schemes not configured"
          fi

          echo "âœ… Info.plist validated"

      - name: ğŸ“¤ Upload iOS Build
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 14

  # --------------------------------------------------------------------------
  # Performance Analysis
  # --------------------------------------------------------------------------
  performance-analysis:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    needs: [android-build]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š APK Composition Analysis
        run: |
          echo "ğŸ“Š Analyzing APK composition..."

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"

          if [ -f "$APK_PATH" ]; then
            # Extract APK
            mkdir -p apk_analysis
            unzip -q "$APK_PATH" -d apk_analysis

            echo "=== Native Libraries ==="
            du -sh apk_analysis/lib/* 2>/dev/null | sort -h || echo "No native libs"

            echo "=== Assets ==="
            du -sh apk_analysis/assets/* 2>/dev/null | sort -h || echo "No assets"

            echo "=== Top 10 Largest Files ==="
            find apk_analysis -type f -exec du -h {} + | sort -rh | head -10
          else
            echo "â­ï¸  APK not available for analysis"
          fi

  # --------------------------------------------------------------------------
  # Production Readiness Report
  # --------------------------------------------------------------------------
  production-report:
    name: ğŸ“‹ Production Report
    runs-on: ubuntu-latest
    needs: [static-analysis, unit-tests, security-scan, android-build, ios-build]
    if: always()

    steps:
      - name: ğŸ“‹ Generate Production Readiness Report
        run: |
          echo "# ğŸ¯ GitaWisdom Production Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter Version**: ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Static Analysis | ${{ needs.static-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.android-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Build | ${{ needs.ios-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [[ "${{ needs.static-analysis.result }}" == "success" ]] && \
             [[ "${{ needs.unit-tests.result }}" == "success" ]] && \
             [[ "${{ needs.security-scan.result }}" == "success" ]] && \
             [[ "${{ needs.android-build.result }}" == "success" ]]; then
            echo "## âœ… Production Ready" >> $GITHUB_STEP_SUMMARY
            echo "All critical checks passed. Build is ready for store submission." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸  Action Required" >> $GITHUB_STEP_SUMMARY
            echo "Some checks failed. Review the job results above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## ğŸ¯ Production Readiness Check

            | Component | Status |
            |-----------|--------|
            | Static Analysis | ${{ needs.static-analysis.result }} |
            | Unit Tests | ${{ needs.unit-tests.result }} |
            | Security Scan | ${{ needs.security-scan.result }} |
            | Android Build | ${{ needs.android-build.result }} |
            | iOS Build | ${{ needs.ios-build.result }} |

            ${needs.android-build.result === 'success' && needs.ios-build.result === 'success' ? 'âœ… All checks passed! Ready for production.' : 'âš ï¸ Some checks failed. Please review.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
