
/*
import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../screens/chapters_screen.dart';
import '../screens/scenarios_screen.dart';
import '../screens/chapters_detail_view.dart';

import '../models/scenario.dart';
import '../models/chapter.dart';

import '../services/supabase_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Supabase.initialize(
  url: 'https://wlfwdtdtiedlcczfoslt.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsZndkdGR0aWVkbGNjemZvc2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4NjQ5MDAsImV4cCI6MjA2NzQ0MDkwMH0.OiWhZled2trJ7eTd8lpQ658B4p-IVsRp2HXHcgAUoFU',
  );
  
// Compatibility layer for packages still using the old TextTheme names
extension TextThemeCompatibility on TextTheme {
  TextStyle? get bodyText2  => bodyMedium;
  TextStyle? get bodyText1  => bodyLarge;
  TextStyle? get subtitle1  => titleMedium;
  TextStyle? get subtitle2  => titleSmall;
  // add more aliases here if you hit other missing getters
}
  runApp(WisdomGuideApp());
}


class WisdomGuideApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Wisdom Guide',
      theme: ThemeData(
        fontFamily: 'Serif',
        scaffoldBackgroundColor: Colors.transparent,
      ),
     // home: MainNavigation(),
        home : RootScaffold(),
    );
  }
}

class MainNavigation extends StatefulWidget {
  @override
  _MainNavigationState createState() => _MainNavigationState();
}

class SplashScreen extends StatefulWidget {
  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _MainNavigationState extends State<MainNavigation> {
  int _selectedIndex = 0;
  
  static final List<Widget> _pages = <Widget>[
    PlaceholderScreen(title: 'Home'),
    ChapterScreen(),
    ScenariosScreen(),
    PlaceholderScreen(title: 'Journal'),
    PlaceholderScreen(title: 'More'),
  ];

  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        Container(
          decoration: BoxDecoration(
            image: DecorationImage(
              image: AssetImage("assets/images/app_bg.png"),
              fit: BoxFit.cover,
            ),
          ),
        ),
        Scaffold(
          backgroundColor: Colors.transparent,
          body: Center(
            child: _pages.elementAt(_selectedIndex),
          ),
          bottomNavigationBar: BottomNavigationBar(
            type: BottomNavigationBarType.fixed,
            items: const <BottomNavigationBarItem>[
              BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
              BottomNavigationBarItem(icon: Icon(Icons.menu_book), label: 'Chapters'),
              BottomNavigationBarItem(icon: Icon(Icons.filter_list), label: 'Scenarios'),
              BottomNavigationBarItem(icon: Icon(Icons.edit), label: 'Journal'),
              BottomNavigationBarItem(icon: Icon(Icons.more_horiz), label: 'More'),
            ],
            currentIndex: _selectedIndex,
            selectedItemColor: Colors.brown,
            onTap: _onItemTapped,
          ),
        ),
      ],
    );
  }
}

class PlaceholderScreen extends StatelessWidget {
  final String title;
  const PlaceholderScreen({Key? key, required this.title}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Text(
      title,
      style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
    );
  }
}

*/

/* START - COMMENTING BEFORE BOTTOM NAVIGATION FIX

import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:path_provider/path_provider.dart';
// import 'package:firebase_core/firebase_core.dart';
// import 'firebase_options.dart'; // generated by flutterfire_cli

//import 'package:hive/hive.dart';
import 'package:hive_flutter/hive_flutter.dart';

import 'dart:io';

import '../screens/home_screen.dart';
import '../screens/chapters_screen.dart';
import '../screens/scenarios_screen.dart';
import '../screens/journal_screen.dart';

// ADDITIONAL SCREENS UNDER ' MORE'

import '../services/settings_service.dart';
import '../services/audio_service.dart';

//import '../services/analytics_service.dart';

import '../screens/more_screen.dart';
import '../screens/references_screen.dart';
import '../screens/about_screen.dart';

//import '../assets/audio/Riverside_Morning_Calm.mp3';

import 'models/chapter.dart';         // üëà Your model
import 'models/journal_entry.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Supabase.initialize(
    url: 'https://wlfwdtdtiedlcczfoslt.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsZndkdGR0aWVkbGNjemZvc2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4NjQ5MDAsImV4cCI6MjA2NzQ0MDkwMH0.OiWhZled2trJ7eTd8lpQ658B4p-IVsRp2HXHcgAUoFU',
  );
  
  // Initializing firebase
//  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  
    // HIVE SPECIFIC CODE
    
    // Initialize Hive with a path
  final appDocDir = await getApplicationDocumentsDirectory();
  Hive.init(appDocDir.path);
  //calling settings
  await SettingsService.init();
   // Register adapters
  Hive.registerAdapter(ChapterAdapter());
  Hive.registerAdapter(JournalEntryAdapter());

  // Open boxes
  await Hive.openBox<Chapter>('chapters');
 // await Hive.openBox<JournalEntry>('journal_entries');

// Try opening journal_entries; if a typeId mismatch occurs, delete & retry
  try {
    await Hive.openBox<JournalEntry>('journal_entries');
  } on HiveError {
    // wipe old box
    try {
      await Hive.deleteBoxFromDisk('journal_entries');
    } catch (e) {
      print('Error deleting journal_entries: $e');
    }
    // reopen fresh
    await Hive.openBox<JournalEntry>('journal_entries');
  } catch (e) {
    print('Unexpected error opening journal_entries: $e');
  }

 // 1. Initialize Hive & your settings box for setting ( color, font size )
  await Hive.initFlutter();
  await SettingsService.init();
  
  
    // load and start music
  final musicOn = await AudioService.instance.loadEnabled();
  if (musicOn) {
    await AudioService.instance.start();
  }
// AudioService.instance.playBackground('assets/audio/Riverside_Morning_Calm.mp3');

  runApp(const WisdomGuideApp());

 
}

/* BFEORE 'MORE SCREEN'
class WisdomGuideApp extends StatelessWidget {
  const WisdomGuideApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Wisdom Guide',
      theme: ThemeData(
        fontFamily: 'Serif',
        scaffoldBackgroundColor: Colors.transparent,
      ),
      home: const SplashScreen(),
    );
  }
}

*/
class WisdomGuideApp extends StatelessWidget {
  const WisdomGuideApp({super.key});

 @override
  Widget build(BuildContext context) {
    // 2. Listen to changes in your settings Hive box
  //  return ValueListenableBuilder(
  //    valueListenable: Hive.box(SettingsService.boxName).listenable(),
    return ValueListenableBuilder<Box>(
     valueListenable: Hive.box(SettingsService.boxName).listenable(),
      builder: (context, Box box, _) {
        // 3a. Read dark / light
        final isDark = box.get(SettingsService.darkKey, defaultValue: false) as bool;

        // 3b. Read font size and map to a scale factor
        final fontPref = box.get(SettingsService.fontKey, defaultValue: 'medium') as String;
        double textScale;
        switch (fontPref) {
          case 'small':
            textScale = 0.85;
            break;
          case 'large':
            textScale = 1.15;
            break;
          case 'medium':
          default:
            textScale = 1.0;
        }

        return MaterialApp(
          debugShowCheckedModeBanner: false,

          // 4. Theme wiring
          theme: ThemeData.light(),
          darkTheme: ThemeData.dark(),
          themeMode: isDark ? ThemeMode.dark : ThemeMode.light,

          // 5. Apply text scale globally
          builder: (context, child) {
            return MediaQuery(
              data: MediaQuery.of(context).copyWith(textScaleFactor: textScale),
              child: child!,
            );
          },
        //  home: MainNavigation(),
          home: RootScaffold(),
        );
      },
    );
  }
  }
  
  
  class RootScaffold extends StatefulWidget {
  @override
  _RootScaffoldState createState() => _RootScaffoldState();
}
class _RootScaffoldState extends State<RootScaffold> {
  int _currentIndex = 0;
  List<Widget> _getPages() => [
    //PlaceholderScreen(title: 'Home'),
    HomeScreen(onTabChange: (index) => setState(() => _currentIndex = index)),
    ChapterScreen(),
    ScenariosScreen(),
    //PlaceholderScreen(title: 'Journal'),
   // JournalScreen(), // MVP - Phase-2
    //PlaceholderScreen(title: 'More'),
    MoreScreen(),
  ];

  @override
  Widget build(BuildContext context) {
    final pages = _getPages();
    return Scaffold(
      body: pages[_currentIndex],
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _currentIndex,
        onTap: (i) => setState(() => _currentIndex = i),
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
          BottomNavigationBarItem(icon: Icon(Icons.book), label: 'Chapters'),
          BottomNavigationBarItem(icon: Icon(Icons.list), label: 'Scenarios'),
          BottomNavigationBarItem(icon: Icon(Icons.edit), label: 'Journal'),
          BottomNavigationBarItem(icon: Icon(Icons.more_horiz), label: 'More'),
          
        ],
      ),
    );
  }
}
  
// üå∏ Splash Screen with Glow + Animation
class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});
  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> with TickerProviderStateMixin {
  late AnimationController _scaleController;
  late Animation<double> _scaleAnimation;
  late AnimationController _glowController;

  @override
  void initState() {
    super.initState();
    //Audio Service
    AudioService.instance.loadEnabled().then((on) {
    if (on) AudioService.instance.start();
    });

   _scaleController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    );
    _scaleAnimation = Tween<double>(begin: 0.9, end: 1.0).animate(
      CurvedAnimation(parent: _scaleController, curve: Curves.easeInOut),
    );
    _scaleController.forward();

    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    )..repeat(reverse: true);


    // ‚è≥ Navigate to MainNavigation after splash
    Future.delayed(const Duration(seconds: 3), () {
      Navigator.pushReplacement(
        context,
       // MaterialPageRoute(builder: (context) => MainNavigation()),
        MaterialPageRoute(builder: (context) => RootScaffold()),
      );
    });
  }

  @override
  void dispose() {
    _scaleController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Stack(
      fit: StackFit.expand,
      children: [
        Image.asset(
          'assets/images/lotus_bg.jpg',
          fit: BoxFit.cover,
        ),
        Center(
          child: AnimatedBuilder(
            animation: _glowController,
            builder: (context, child) {
              return Container(
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.amber.withOpacity(0.3),
                      blurRadius: 20 + (_glowController.value * 10),
                      spreadRadius: 2,
                    ),
                  ],
                ),
              );
            },
          ),
        ),
      ],
    );
  }
}

// üß≠ Main Navigation after splash
// START - BEFORE FULL NAVIGATION
// class MainNavigation extends StatefulWidget {
//  @override
//  _MainNavigationState createState() => _MainNavigationState();
// }

class MainNavigation extends StatefulWidget {
  const MainNavigation({Key? key}) : super(key: key);
  @override
  _MainNavigationState  createState() => _MainNavigationState();
}

class _MainNavigationState extends State<MainNavigation> {
  int _selectedIndex = 0;

  static final List<Widget> _pages = <Widget>[
    //PlaceholderScreen(title: 'Home'),
    HomeScreen(),
    ChapterScreen(),
    ScenariosScreen(),
    //PlaceholderScreen(title: 'Journal'),
   // JournalScreen(), // MVP - Phase-2
    //PlaceholderScreen(title: 'More'),
    MoreScreen(),
  ];
  
  final List<BottomNavigationBarItem> _navItems = const [
    BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
    BottomNavigationBarItem(icon: Icon(Icons.book), label: 'Chapters'),
    BottomNavigationBarItem(icon: Icon(Icons.filter_list), label: 'Scenarios'),
    BottomNavigationBarItem(icon: Icon(Icons.more_horiz), label: 'More'),
  ];

  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
  }

// START - ALL SCREENS NAVIGATION

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        Container(
          decoration: const BoxDecoration(
            image: DecorationImage(
              image: AssetImage("assets/images/divine_scroll_bg.png"),
              fit: BoxFit.cover,
            ),
          ),
        ),
        Scaffold(
          backgroundColor: Colors.transparent,
          body: Center(
            child: _pages.elementAt(_selectedIndex),
          ),
          bottomNavigationBar: BottomNavigationBar(
            type: BottomNavigationBarType.fixed,
            items: const <BottomNavigationBarItem>[
              BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
              BottomNavigationBarItem(icon: Icon(Icons.menu_book), label: 'Chapters'),
              BottomNavigationBarItem(icon: Icon(Icons.filter_list), label: 'Scenarios'),
            //  BottomNavigationBarItem(icon: Icon(Icons.edit), label: 'Journal'),
              BottomNavigationBarItem(icon: Icon(Icons.more_horiz), label: 'More'),
            ],
            currentIndex: _selectedIndex,
            selectedItemColor: Colors.brown,
            onTap: _onItemTapped,
          ),
        ),
      ],
    );
  }
 //FINISH ALL STATES NAVIGATION
 
 @override
  Widget build(BuildContext context) {
    assert(_pages.length == _navItems.length,
      'Pages length (${_pages.length}) must match nav items length (${_navItems.length})');

    // clamp in case something tries to set a bad index
    final safeIndex = _currentIndex.clamp(0, _pages.length - 1);

    return Scaffold(
      body: IndexedStack(
                currentIndex: safeIndex,
        children: _pages,
      ),
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: safeIndex,
        items: _navItems,
        onTap: (i) {
          setState(() {
            // if someone taps the same tab, you could pop to root, etc.
            _currentIndex = i.clamp(0, _pages.length - 1);
          });
        },
      ),
    );
  }
  
}

class PlaceholderScreen extends StatelessWidget {
  final String title;
  const PlaceholderScreen({Key? key, required this.title}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Text(
      title,
      style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
    );
  }
}

*/

// lib/main.dart

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:path_provider/path_provider.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'package:google_fonts/google_fonts.dart'; // FOR GOOGLE FONT

import 'l10n/app_localizations.dart';

import 'models/daily_verse_set.dart';
import 'models/chapter_summary.dart';
import 'models/verse.dart';
import 'models/scenario.dart';
import 'services/daily_verse_service.dart';
import 'services/scenario_service.dart';
import 'services/journal_service.dart';
import 'services/favorites_service.dart';


import 'models/chapter.dart';
import 'models/journal_entry.dart';
import 'models/user_favorite.dart';
import '../widgets/custom_nav_bar.dart';
import '../services/settings_service.dart';
import 'services/audio_service.dart';
import 'config/environment.dart'; // üëà Import our environment config

import 'screens/home_screen.dart';
import 'screens/chapters_screen.dart';
import 'screens/scenarios_screen.dart';
import 'screens/journal_screen.dart';
import 'screens/more_screen.dart';

import 'package:flutter_svg/flutter_svg.dart';
// lib/main.dart


void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Set full-screen app layout - ensure app uses full device size
  SystemChrome.setEnabledSystemUIMode(SystemUiMode.edgeToEdge);
  SystemChrome.setSystemUIOverlayStyle(const SystemUiOverlayStyle(
    statusBarColor: Colors.transparent,
    statusBarIconBrightness: Brightness.light,
    systemNavigationBarColor: Colors.transparent,
    systemNavigationBarDividerColor: Colors.transparent,
  ));

  try {
    // ‚úÖ Critical initialization only - everything else will be lazy loaded
    Environment.validateConfiguration();

    // ‚úÖ Initialize Supabase (essential for app functionality)
    await Supabase.initialize(
      url: Environment.supabaseUrl,
      anonKey: Environment.supabaseAnonKey,
    );

    // ‚úÖ Basic Hive setup only
    final appDocDir = await getApplicationDocumentsDirectory();
    Hive.init(appDocDir.path);
    await SettingsService.init();

    runApp(const WisdomGuideApp());

  } catch (error, stackTrace) {
    debugPrint('‚ùå Critical initialization failed: $error');
    debugPrint('Stack trace: $stackTrace');
    runApp(InitializationErrorApp(error: error));
  }
}

// Lazy initialization function called after app starts
Future<void> _initializeAppServices() async {
  try {
    // Register Hive adapters
    if (!Hive.isAdapterRegistered(0)) {
      Hive.registerAdapter(JournalEntryAdapter()); // typeId: 0
    }
    if (!Hive.isAdapterRegistered(1)) {
      Hive.registerAdapter(ChapterAdapter()); // typeId: 1
    }
    if (!Hive.isAdapterRegistered(2)) {
      Hive.registerAdapter(DailyVerseSetAdapter()); // typeId: 2
    }
    if (!Hive.isAdapterRegistered(3)) {
      Hive.registerAdapter(ChapterSummaryAdapter()); // typeId: 3
    }
    if (!Hive.isAdapterRegistered(4)) {
      Hive.registerAdapter(VerseAdapter()); // typeId: 4
    }
    if (!Hive.isAdapterRegistered(5)) {
      Hive.registerAdapter(ScenarioAdapter()); // typeId: 5
    }
    if (!Hive.isAdapterRegistered(6)) {
      Hive.registerAdapter(UserFavoriteAdapter()); // typeId: 6
    }

    // Open boxes with error handling
    if (!Hive.isBoxOpen('chapters')) {
      await Hive.openBox<Chapter>('chapters');
    }

    if (!Hive.isBoxOpen('journal_entries')) {
      try {
        await Hive.openBox<JournalEntry>('journal_entries');
      } on HiveError {
        await Hive.deleteBoxFromDisk('journal_entries');
        await Hive.openBox<JournalEntry>('journal_entries');
      }
    }

    // Open daily verse service box
    await DailyVerseService.instance.initialize();
    
    // Open scenario service box
    await ScenarioService.instance.initialize();
    
    // Open journal service box
    await JournalService.instance.initialize();
    
    // Open favorites service box
    await FavoritesService.instance.initialize();

    // Initialize audio service (non-blocking)
    AudioService.instance.loadEnabled().then((musicEnabled) {
      if (musicEnabled) {
        AudioService.instance.start().catchError((e) {
          debugPrint('Audio initialization failed: $e');
        });
      }
    });

    debugPrint('‚úÖ App services initialized');
  } catch (e) {
    debugPrint('‚ö†Ô∏è Non-critical service initialization failed: $e');
  }
}

/// Error app shown when initialization fails
class InitializationErrorApp extends StatelessWidget {
  final Object error;

  const InitializationErrorApp({
    Key? key,
    required this.error,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'GitaWisdom - Configuration Error',
      home: Scaffold(
        body: Center(
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(
                  Icons.error_outline,
                  size: 64,
                  color: Colors.red,
                ),
                const SizedBox(height: 16),
                const Text(
                  'Configuration Error',
                  style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 16),
                Text(
                  'The app could not initialize properly. Please check your configuration.',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: Colors.grey[600]),
                ),
                if (Environment.isDevelopment) ...[
                  const SizedBox(height: 16),
                  Text(
                    'Error: $error',
                    textAlign: TextAlign.center,
                    style: const TextStyle(
                      fontSize: 12,
                      fontFamily: 'monospace',
                      color: Colors.red,
                    ),
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }
}

  /*  // ‚Äî Supabase
  await Supabase.initialize(
    url: 'https://wlfwdtdtiedlcczfoslt.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsZndkdGR0aWVkbGNjemZvc2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4NjQ5MDAsImV4cCI6MjA2NzQ0MDkwMH0.OiWhZled2trJ7eTd8lpQ658B4p-IVsRp2HXHcgAUoFU',
  );

  // ‚Äî Hive setup
  final appDocDir = await getApplicationDocumentsDirectory();
  Hive.init(appDocDir.path);
  await SettingsService.init();

  Hive.registerAdapter(ChapterAdapter());
  Hive.registerAdapter(JournalEntryAdapter());

  await Hive.openBox<Chapter>('chapters');
  try {
    await Hive.openBox<JournalEntry>('journal_entries');
  } on HiveError {
    await Hive.deleteBoxFromDisk('journal_entries');
    await Hive.openBox<JournalEntry>('journal_entries');
  }

  // ‚Äî Audio
  final musicOn = await AudioService.instance.loadEnabled();
  if (musicOn) await AudioService.instance.start();

  runApp(const WisdomGuideApp());
}
  */



class WisdomGuideApp extends StatelessWidget {
  const WisdomGuideApp({Key? key}) : super(key: key);

  TextTheme _buildTextThemeWithShadows(TextTheme baseTheme, bool shadowEnabled) {
    final shadows = shadowEnabled ? [
      const Shadow(
        color: Colors.black45,
        offset: Offset(1.0, 1.0),
        blurRadius: 2.0,
      ),
    ] : <Shadow>[];

    return baseTheme.copyWith(
      displayLarge: baseTheme.displayLarge?.copyWith(shadows: shadows),
      displayMedium: baseTheme.displayMedium?.copyWith(shadows: shadows),
      displaySmall: baseTheme.displaySmall?.copyWith(shadows: shadows),
      headlineLarge: baseTheme.headlineLarge?.copyWith(shadows: shadows),
      headlineMedium: baseTheme.headlineMedium?.copyWith(shadows: shadows),
      headlineSmall: baseTheme.headlineSmall?.copyWith(shadows: shadows),
      titleLarge: baseTheme.titleLarge?.copyWith(shadows: shadows),
      titleMedium: baseTheme.titleMedium?.copyWith(shadows: shadows),
      titleSmall: baseTheme.titleSmall?.copyWith(shadows: shadows),
      bodyLarge: baseTheme.bodyLarge?.copyWith(shadows: shadows),
      bodyMedium: baseTheme.bodyMedium?.copyWith(shadows: shadows),
      bodySmall: baseTheme.bodySmall?.copyWith(shadows: shadows),
      labelLarge: baseTheme.labelLarge?.copyWith(shadows: shadows),
      labelMedium: baseTheme.labelMedium?.copyWith(shadows: shadows),
      labelSmall: baseTheme.labelSmall?.copyWith(shadows: shadows),
    );
  }

  /// Build app background - supports both image and theme-based backgrounds
  Widget _buildAppBackground(bool isDark, double opacity) {
    // Option 1: Theme-based background (currently active)
    return _buildThemeBasedBackground(isDark, opacity);
    
    // Option 2: Image-based background (commented out but preserved)
    // To switch back to image background, comment out the line above and uncomment below:
    // return _buildImageBackground(opacity);
  }

  /// Theme-based background with accent colors (not full bright/dark)
  Widget _buildThemeBasedBackground(bool isDark, double opacity) {
    if (isDark) {
      // Dark theme: Enhanced to match the quality of light theme
      return Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              const Color(0xFF2C2C2C).withOpacity(opacity), // Warmer dark base (like light theme warmth)
              const Color(0xFF3A3A3A).withOpacity(opacity), // Mid-tone for depth
              const Color(0xFF2E2E3E).withOpacity(opacity), // Subtle purple accent (elegant like light theme)
              const Color(0xFF404040).withOpacity(opacity), // Lighter edge for dimension
            ],
            stops: const [0.0, 0.4, 0.7, 1.0],
          ),
        ),
      );
    } else {
      // Light theme: Soft warm gray with subtle accent (#FAFAFA base)
      return Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              const Color(0xFFFAFAFA).withOpacity(opacity), // Soft white base
              const Color(0xFFF5F5F5).withOpacity(opacity), // Light gray for gradient
              const Color(0xFFF0F0F8).withOpacity(opacity), // Warm accent
            ],
            stops: const [0.0, 0.7, 1.0],
          ),
        ),
      );
    }
  }

  /// Image-based background (preserved for future use)
  Widget _buildImageBackground(double opacity) {
    return Opacity(
      opacity: opacity,
      child: Image.asset('assets/images/app_bg.png', fit: BoxFit.cover),
    );
  }

  @override
  Widget build(BuildContext context) {
    return ValueListenableBuilder<Box>(
      valueListenable: Hive.box(SettingsService.boxName).listenable(),
      builder: (context, box, _) {
        final isDark = box.get(SettingsService.darkKey, defaultValue: false) as bool;
        final fontPref = box.get(SettingsService.fontKey, defaultValue: 'medium') as String;
        final shadowEnabled = box.get(SettingsService.shadowKey, defaultValue: false) as bool;
        final backgroundOpacity = box.get(SettingsService.opacityKey, defaultValue: 1.0) as double;
        final languageCode = box.get(SettingsService.langKey, defaultValue: 'en') as String;
        
        double textScale;
        switch (fontPref) {
          case 'small':    textScale = 0.90; break; // Reduced scaling to prevent overflow
          case 'large':    textScale = 1.05; break; // Reduced scaling to prevent overflow
          default:         textScale = 1.0;
        }

        return MaterialApp(
          debugShowCheckedModeBanner: false,
          
          // Localization setup
          locale: Locale(languageCode),
          localizationsDelegates: const [
            AppLocalizations.delegate,
            GlobalMaterialLocalizations.delegate,
            GlobalWidgetsLocalizations.delegate,
            GlobalCupertinoLocalizations.delegate,
          ],
          supportedLocales: const [
            Locale('en', ''), // English
            Locale('es', ''), // Spanish  
            Locale('hi', ''), // Hindi
          ],
          
          theme: ThemeData.light().copyWith(
            scaffoldBackgroundColor: Colors.transparent,
            textTheme: _buildTextThemeWithShadows(
              GoogleFonts.poppinsTextTheme(ThemeData.light().textTheme),
              shadowEnabled,
            ),
            cardTheme: CardThemeData(
              color: ThemeData.light().colorScheme.surface,
              elevation: 8,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
              margin: const EdgeInsets.symmetric(vertical: 8),
            ),
          ),
          darkTheme: ThemeData.dark().copyWith(
            scaffoldBackgroundColor: Colors.transparent,
            textTheme: _buildTextThemeWithShadows(
              GoogleFonts.poppinsTextTheme(ThemeData.dark().textTheme),
              shadowEnabled,
            ),
            cardTheme: CardThemeData(
              color: ThemeData.dark().colorScheme.surface,
              elevation: 8,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
              margin: const EdgeInsets.symmetric(vertical: 8),
            ),
          ),
          themeMode: isDark ? ThemeMode.dark : ThemeMode.light,
          builder: (context, child) {
            final mq = MediaQuery.of(context).copyWith(textScaler: TextScaler.linear(textScale));
            return MediaQuery(
              data: mq,
              child: Stack(
                children: [
                  // Background system - choose between image and theme-based
                  Positioned.fill(
              //                     child: Opacity(
              //                            opacity: backgroundOpacity,
              //                            child: Image.asset('assets/images/app_bg.png', fit: BoxFit.cover),
              //                     ),

                    child: _buildAppBackground(isDark, backgroundOpacity),
                  ),
                  if (child != null) child,
                ],
              ),
            );
          },
          home: const SplashScreen(),
        );
      },
    );
  }
}

class SplashScreen extends StatefulWidget {
  const SplashScreen({Key? key}) : super(key: key);
  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> with SingleTickerProviderStateMixin {
  @override
  void initState() {
    super.initState();
    
    // Initialize remaining services while showing splash screen
    _initializeAppServices();
    
    // Navigate to root after 3 seconds
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        Navigator.of(context).pushReplacement(
          MaterialPageRoute(builder: (_) => const RootScaffold()),
        );
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return AnnotatedRegion<SystemUiOverlayStyle>(
      value: const SystemUiOverlayStyle(
        statusBarColor: Colors.transparent,
        statusBarIconBrightness: Brightness.light,
        systemNavigationBarColor: Colors.transparent,
      ),
      child: Scaffold(
        extendBodyBehindAppBar: true,
        extendBody: true,
        body: SizedBox(
          width: MediaQuery.of(context).size.width,
          height: MediaQuery.of(context).size.height,
          child: Container(
            decoration: const BoxDecoration(
              image: DecorationImage(
                image: AssetImage('assets/images/app_bg.png'),
                fit: BoxFit.cover,
              ),
            ),
            child: SafeArea(
              child: Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // App logo or loading indicator
                    const Icon(
                      Icons.auto_stories,
                      size: 80,
                      color: Colors.white,
                    ),
                    const SizedBox(height: 20),
                    Text(
                      'GitaWisdom',
                      style: Theme.of(context).textTheme.headlineLarge?.copyWith(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        shadows: [
                          const Shadow(
                            offset: Offset(0, 2),
                            blurRadius: 4,
                            color: Colors.black54,
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 40),
                    const CircularProgressIndicator(
                      valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// Public navigation methods
class NavigationHelper {
  static void goToScenariosWithChapter(int chapterId) {
    _RootScaffoldState.goToScenariosWithChapter(chapterId);
  }
}

class RootScaffold extends StatefulWidget {
  const RootScaffold({Key? key}) : super(key: key);
  @override
  State<RootScaffold> createState() => _RootScaffoldState();
}

class _RootScaffoldState extends State<RootScaffold> {
  static _RootScaffoldState? _instance;
  int _currentIndex = 0;
  int? _pendingChapterFilter; // Store chapter filter to apply to scenarios tab
  late List<Widget> _pages; // Cache pages to prevent recreation

  static void goToTab(int index) => _instance?._selectTab(index);
  
  static void goToScenariosWithChapter(int chapterId) {
    _instance?._goToScenariosWithChapter(chapterId);
  }

  @override
  void initState() {
    super.initState();
    _instance = this;
    _navigatorKeys = List.generate(5, (_) => GlobalKey<NavigatorState>());
    _initializePages();
  }

  void _initializePages() {
    _pages = [
      HomeScreen(onTabChange: _selectTab),
      ChapterScreen(),
      ScenariosScreen(filterChapter: _pendingChapterFilter),
    //  JournalScreen(),
      MoreScreen(),
    ];
  }
  @override
  void dispose() {
    _instance = null;
    super.dispose();
  }

  void _selectTab(int index) {
    if (index == _currentIndex) {
      // If tapping same tab, pop to root
      _navigatorKeys[index].currentState?.popUntil((r) => r.isFirst);
    } else {
      // Reset navigator state when switching tabs to prevent stale state
      _navigatorKeys[index] = GlobalKey<NavigatorState>();
      setState(() => _currentIndex = index);
    }
  }
  
  void _goToScenariosWithChapter(int chapterId) {
    debugPrint('üîß NavigationHelper._goToScenariosWithChapter: chapterId=$chapterId');
    _pendingChapterFilter = chapterId;
    
    // Recreate scenarios screen with new filter
    _pages[2] = ScenariosScreen(filterChapter: _pendingChapterFilter);
    debugPrint('üîß NavigationHelper._goToScenariosWithChapter: Created new ScenariosScreen with filterChapter=$_pendingChapterFilter');
    
    // Create a new navigator key to force the Navigator to rebuild with the new screen
    _navigatorKeys[2] = GlobalKey<NavigatorState>();
    debugPrint('üîß NavigationHelper._goToScenariosWithChapter: Created new navigator key for scenarios tab');
    
    // Trigger a rebuild to use the new ScenariosScreen instance
    setState(() {
      _currentIndex = 2; // Switch to scenarios tab (index 2)
    });
    debugPrint('üîß NavigationHelper._goToScenariosWithChapter: Switched to scenarios tab with setState');
  }

  late List<GlobalKey<NavigatorState>> _navigatorKeys;

  Widget _buildOffstageNavigator(int idx, Widget screen) {
    return Offstage(
      offstage: _currentIndex != idx,
      child: Navigator(
        key: _navigatorKeys[idx],
        onGenerateRoute: (_) => MaterialPageRoute(builder: (_) => screen),
        // Add a unique key that changes when scenarios screen is updated
        // This forces Navigator to rebuild when we change the scenarios screen
      ),
    );
  }

  Future<bool> _onWillPop() async {
    final navigatorState = _navigatorKeys[_currentIndex].currentState;
    if (navigatorState == null) {
      // If navigator state is null, just switch to home
      if (_currentIndex != 0) {
        setState(() => _currentIndex = 0);
        return false;
      }
      return true;
    }
    
    final isFirst = !await navigatorState.maybePop();
    if (isFirst) {
      if (_currentIndex != 0) {
        setState(() => _currentIndex = 0);
        return false;
      }
      return true;
    }
    return false;
  }

  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      onWillPop: _onWillPop,
      child: Scaffold(
        body: Stack(
          children: List.generate(_pages.length, (i) => _buildOffstageNavigator(i, _pages[i])),
        ),
        bottomNavigationBar: CustomNavBar(
          currentIndex: _currentIndex,
          onTap: (i) => _selectTab(i),
          items: [
            NavBarItem(icon: Icons.home, label: AppLocalizations.of(context)!.homeTab),
            NavBarItem(icon: Icons.menu_book, label: AppLocalizations.of(context)!.chaptersTab),
            NavBarItem(icon: Icons.list, label: AppLocalizations.of(context)!.scenariosTab),
         //   NavBarItem(icon: Icons.book, label: AppLocalizations.of(context)!.journalTab),
            NavBarItem(icon: Icons.more_horiz, label: AppLocalizations.of(context)!.moreTab),
          ],
        ),
      ),
    );
  }
}
